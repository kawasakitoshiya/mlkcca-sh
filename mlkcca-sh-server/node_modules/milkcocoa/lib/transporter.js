function Transporter(t,o,e,s){function n(t){c._is_connected=!0,c.flush(),myconsole.log("transporter:onopen",t),s&&s(t),c._onConnected&&c._onConnected()}function r(t){c._is_connected=!1,myconsole.log("transporter:onclose",t),c._onClosed&&c._onClosed()}function i(t){myconsole.log("transporter:onerror",t.message),c._onError&&c._onError(t)}function p(t,o){var e={};try{e=JSON.parse(c.decode(o))}catch(s){e=JSON.parse(o)}var n=t.indexOf("/"),r=t.lastIndexOf("/"),i=t.substr(n+1,r-n-1),p=t.substr(r+1),a={path:i,event:p,content:e};c._onMessage(a)}var c=this;this.sid=e,this.queue=[],this.callbacks={},this.app_id=o.app_id,this.host=t,this.port=o.port||443,this.http_port=o.port||443,this.useSSL=!0,this.qos=0;var a="s"+e||"dammy";o.token&&(a="j"+o.token),o.hasOwnProperty("qos")&&(this.qos=o.qos),o.hasOwnProperty("useSSL")&&(this.useSSL=o.useSSL);var h=(this.useSSL?"wss://":"ws://")+t+":"+this.port+"/websocket";"browser"!==process.title?(this.port=this.useSSL?8883:1883,h=(this.useSSL?"mqtts://":"mqtt://")+t+":"+this.port):useragent.isAndroidStandardBrowser()&&(h=(this.useSSL?"sockjss://":"sockjs://")+t+":"+this.port+"/sockjs"),console.log(o.clientId),this.client=mows.connect(h,{username:a,clientId:o.clientId,password:o.app_id,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:7e3,clean:!1}),this.client.onConnectionLost=r,this.client.onMessageArrived=p,this.client.on("connect",n),this.client.on("close",r),this.client.on("error",i),this.client.on("message",p),this._is_connected=!1}var myconsole=require("./logger"),useragent=require("./ua"),ajax=require("./ajax"),mows=require("mqtt");module.exports=Transporter,Transporter.prototype.encode=function(t){return t},Transporter.decode=function(t){return decodeURIComponent(t)},Transporter.prototype.decode=function(t){return Transporter.decode(t)},Transporter.prototype.onMessage=function(t){this._onMessage=t},Transporter.prototype.onConnected=function(t){this._onConnected=t},Transporter.prototype.onClosed=function(t){this._onClosed=t},Transporter.prototype.onError=function(t){this._onError=t},Transporter.prototype.auth_call=function(t,o,e){o.cmd=t,o.appid=this.app_id,ajax.request("POST",this.useSSL,this.host,this.http_port,"/auth",o,e)},Transporter.prototype.call=function(t,o,e){o.api=t,o.appid=this.app_id,this.sid&&(o.mlkccasid=this.sid),ajax.request("GET",this.useSSL,this.host,this.http_port,"/api",o,e)},Transporter.prototype.on=function(t,o){this.send({type:"s",topic:this.create_topic(t,o)})},Transporter.prototype.off=function(t,o){this.send({type:"u",topic:this.create_topic(t,o)})},Transporter.prototype.send_operation_request=function(t,o,e,s){this.send({type:"p",topic:this.create_topic(t,o),msg:JSON.stringify(e)})},Transporter.prototype.create_topic=function(t,o){return this.app_id+"/"+t+"/"+o},Transporter.prototype.send=function(t){var o=this;o._is_connected?o.send_op(t):o.queue.push(t)},Transporter.prototype.flush=function(){this.send_next()},Transporter.prototype.send_next=function(){var t=this;if(t._is_connected){var o=t.queue.shift();o&&(t.send_op(o),t.send_next())}},Transporter.prototype.send_op=function(t){var o=this;switch(t.type){case"p":var e=o.encode(t.msg);o.client.publish(t.topic,e,{qos:o.qos,retain:!1});break;case"s":o.client.subscribe(t.topic,{qos:o.qos});break;case"u":o.client.unsubscribe(t.topic)}},Transporter.prototype.disconnect=function(t){this.client.end(t)};